/**
 * ุฅุนุฏุงุฏ ูุงุนุฏุฉ ุจูุงูุงุช SQLite ูุจุฏูู ูุคูุช ูู MySQL
 * ูููู ุงุณุชุฎุฏุงููุง ููุงุฎุชุจุงุฑ ูุงูุชุทููุฑ ูุจู ุชุซุจูุช MySQL
 */

const sqlite3 = require('sqlite3').verbose();
const path = require('path');

// ูุณุงุฑ ููู ูุงุนุฏุฉ ุงูุจูุงูุงุช
const dbPath = path.join(__dirname, '..', 'data', 'tamsik.db');

// ุฅูุดุงุก ูุฌูุฏ ุงูุจูุงูุงุช ุฅุฐุง ูู ููู ููุฌูุฏุงู
const fs = require('fs');
const dataDir = path.dirname(dbPath);
if (!fs.existsSync(dataDir)) {
    fs.mkdirSync(dataDir, { recursive: true });
}

// ุฅูุดุงุก ูุงุนุฏุฉ ุงูุจูุงูุงุช
const db = new sqlite3.Database(dbPath, (err) => {
    if (err) {
        console.error('โ ุฎุทุฃ ูู ุฅูุดุงุก ูุงุนุฏุฉ ุจูุงูุงุช SQLite:', err.message);
    } else {
        console.log('โ ุชู ุฅูุดุงุก ูุงุนุฏุฉ ุจูุงูุงุช SQLite ุจูุฌุงุญ');
    }
});

// ุชุญููู ุงุณุชุนูุงูุงุช MySQL ุฅูู SQLite
const createTables = {
    users: `
        CREATE TABLE IF NOT EXISTS users (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            username TEXT UNIQUE NOT NULL,
            email TEXT UNIQUE NOT NULL,
            password TEXT NOT NULL,
            full_name TEXT,
            role TEXT DEFAULT 'user',
            is_active INTEGER DEFAULT 1,
            created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
            updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
        )
    `,
    
    categories: `
        CREATE TABLE IF NOT EXISTS categories (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            name TEXT NOT NULL,
            description TEXT,
            created_at DATETIME DEFAULT CURRENT_TIMESTAMP
        )
    `,
    
    verses_suggestions: `
        CREATE TABLE IF NOT EXISTS verses_suggestions (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            user_id INTEGER,
            verse_text TEXT NOT NULL,
            surah_name TEXT,
            verse_number INTEGER,
            context_type TEXT DEFAULT 'ุนุงู',
            topic TEXT,
            usage_count INTEGER DEFAULT 1,
            created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
            updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
            FOREIGN KEY (user_id) REFERENCES users(id)
        )
    `,
    
    hadith_suggestions: `
        CREATE TABLE IF NOT EXISTS hadith_suggestions (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            user_id INTEGER,
            hadith_text TEXT NOT NULL,
            narrator TEXT,
            source TEXT,
            authentication TEXT,
            context_type TEXT DEFAULT 'ุนุงู',
            topic TEXT,
            usage_count INTEGER DEFAULT 1,
            created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
            updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
            FOREIGN KEY (user_id) REFERENCES users(id)
        )
    `,
    
    athar_suggestions: `
        CREATE TABLE IF NOT EXISTS athar_suggestions (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            user_id INTEGER,
            athar_text TEXT NOT NULL,
            speaker TEXT,
            context_type TEXT DEFAULT 'ุนุงู',
            topic TEXT,
            usage_count INTEGER DEFAULT 1,
            created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
            updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
            FOREIGN KEY (user_id) REFERENCES users(id)
        )
    `,
    
    saja_suggestions: `
        CREATE TABLE IF NOT EXISTS saja_suggestions (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            user_id INTEGER,
            saja_text TEXT NOT NULL,
            topic TEXT,
            rhyme TEXT,
            attribution TEXT,
            reference TEXT,
            usage_count INTEGER DEFAULT 1,
            created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
            updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
            FOREIGN KEY (user_id) REFERENCES users(id)
        )
    `,
    
    poetry_suggestions: `
        CREATE TABLE IF NOT EXISTS poetry_suggestions (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            user_id INTEGER,
            poetry_text TEXT NOT NULL,
            topic TEXT,
            rhyme TEXT,
            meter TEXT,
            poet TEXT,
            reference TEXT,
            usage_count INTEGER DEFAULT 1,
            created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
            updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
            FOREIGN KEY (user_id) REFERENCES users(id)
        )
    `,
    
    dua_suggestions: `
        CREATE TABLE IF NOT EXISTS dua_suggestions (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            user_id INTEGER,
            dua_text TEXT NOT NULL,
            dua_type TEXT NOT NULL,
            topic TEXT,
            source TEXT,
            usage_count INTEGER DEFAULT 1,
            created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
            updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
            FOREIGN KEY (user_id) REFERENCES users(id)
        )
    `,
    
    sermons: `
        CREATE TABLE IF NOT EXISTS sermons (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            user_id INTEGER,
            category_id INTEGER,
            title TEXT NOT NULL,
            content TEXT,
            excerpt TEXT,
            author TEXT,
            status TEXT DEFAULT 'draft',
            is_featured INTEGER DEFAULT 0,
            views_count INTEGER DEFAULT 0,
            tags TEXT,
            attachments TEXT,
            created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
            updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
            FOREIGN KEY (user_id) REFERENCES users(id),
            FOREIGN KEY (category_id) REFERENCES categories(id)
        )
    `
};

// ุฏุงูุฉ ูุฅูุดุงุก ุงูุฌุฏุงูู
async function createAllTables() {
    return new Promise((resolve, reject) => {
        const tableNames = Object.keys(createTables);
        let completed = 0;
        
        console.log('๐ ุฅูุดุงุก ุฌุฏุงูู ูุงุนุฏุฉ ุงูุจูุงูุงุช...');
        
        tableNames.forEach(tableName => {
            db.run(createTables[tableName], (err) => {
                if (err) {
                    console.error(`โ ุฎุทุฃ ูู ุฅูุดุงุก ุฌุฏูู ${tableName}:`, err.message);
                    reject(err);
                } else {
                    console.log(`โ ุชู ุฅูุดุงุก ุฌุฏูู ${tableName}`);
                    completed++;
                    
                    if (completed === tableNames.length) {
                        resolve();
                    }
                }
            });
        });
    });
}

// ุฏุงูุฉ ูุฅุฏุฑุงุฌ ุงูุจูุงูุงุช ุงูุฃูููุฉ
async function insertInitialData() {
    return new Promise((resolve, reject) => {
        console.log('๐ ุฅุฏุฑุงุฌ ุงูุจูุงูุงุช ุงูุฃูููุฉ...');
        
        // ุฅุฏุฑุงุฌ ูุฆุงุช ุฃุณุงุณูุฉ
        const categories = [
            'ุงูุนููุฏุฉ',
            'ุงูููู', 
            'ุงูุฃุฎูุงู ูุงูุขุฏุงุจ',
            'ุงูุณูุฑุฉ ุงููุจููุฉ',
            'ุงูุชูุณูุฑ',
            'ุงูุญุฏูุซ',
            'ุงูุฏุนูุฉ ูุงูุฅุฑุดุงุฏ',
            'ุงูููุงุณุจุงุช ุงูุฅุณูุงููุฉ'
        ];
        
        const insertCategory = db.prepare('INSERT OR IGNORE INTO categories (name, description) VALUES (?, ?)');
        
        categories.forEach(category => {
            insertCategory.run(category, `ูุฆุฉ ${category}`);
        });
        
        insertCategory.finalize();
        
        // ุฅุฏุฑุงุฌ ุงูุชุฑุงุญุงุช ุฃูููุฉ ููุขูุงุช
        const insertVerse = db.prepare(`
            INSERT OR IGNORE INTO verses_suggestions 
            (verse_text, surah_name, verse_number, context_type, topic) 
            VALUES (?, ?, ?, ?, ?)
        `);
        
        insertVerse.run(
            'ููุง ุฃููููููุง ุงูููุฐูููู ุขูููููุง ุงุชูููููุง ุงูููููู ุญูููู ุชูููุงุชููู ููููุง ุชููููุชูููู ุฅููููุง ููุฃููุชูู ูููุณูููููููู',
            'ุขู ุนูุฑุงู',
            102,
            'ุฃูุฑ',
            'ุงูุชููู'
        );

        insertVerse.run(
            'ููููู ููุชูููู ุงูููููู ููุฌูุนูู ููููู ููุฎูุฑูุฌูุง ููููุฑูุฒููููู ูููู ุญูููุซู ููุง ููุญูุชูุณูุจู',
            'ุงูุทูุงู',
            2,
            'ูุนุฏ',
            'ุงูุชููู'
        );

        insertVerse.finalize((err) => {
            if (err) {
                console.error('โ ุฎุทุฃ ูู ุฅุฏุฑุงุฌ ุงูุขูุงุช:', err);
            } else {
                console.log('โ ุชู ุฅุฏุฑุงุฌ ุงูุขูุงุช ุจูุฌุงุญ');
            }
        });
        
        // ุฅุฏุฑุงุฌ ุงูุชุฑุงุญุงุช ุฃูููุฉ ููุฏุนุงุก
        const insertDua = db.prepare(`
            INSERT OR IGNORE INTO dua_suggestions 
            (dua_text, dua_type, topic, source) 
            VALUES (?, ?, ?, ?)
        `);
        
        insertDua.run(
            'ุงูุญูุฏ ููู ุฑุจ ุงูุนุงููููุ ุงูุฑุญูู ุงูุฑุญููุ ูุงูู ููู ุงูุฏูู',
            'ุซูุงุก',
            'ุนุงู',
            'ุงููุฑุขู ุงููุฑูู'
        );
        
        insertDua.run(
            'ุฑุจูุง ุขุชูุง ูู ุงูุฏููุง ุญุณูุฉ ููู ุงูุขุฎุฑุฉ ุญุณูุฉ ูููุง ุนุฐุงุจ ุงููุงุฑ',
            'ุฏุนุงุก ูุฑุขูู',
            'ุนุงู',
            'ุณูุฑุฉ ุงูุจูุฑุฉ'
        );
        
        insertDua.finalize();
        
        console.log('โ ุชู ุฅุฏุฑุงุฌ ุงูุจูุงูุงุช ุงูุฃูููุฉ ุจูุฌุงุญ');
        resolve();
    });
}

// ุฏุงูุฉ ุงูุชููุฆุฉ ุงูุฑุฆูุณูุฉ
async function initializeSQLite() {
    try {
        await createAllTables();
        await insertInitialData();
        console.log('๐ ุชู ุชููุฆุฉ ูุงุนุฏุฉ ุจูุงูุงุช SQLite ุจูุฌุงุญ!');
        console.log(`๐ ูุณุงุฑ ูุงุนุฏุฉ ุงูุจูุงูุงุช: ${dbPath}`);
        return true;
    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุชููุฆุฉ ูุงุนุฏุฉ ุงูุจูุงูุงุช:', error);
        return false;
    }
}

// ุชุดุบูู ุงูุชููุฆุฉ ุฅุฐุง ุชู ุงุณุชุฏุนุงุก ุงูููู ูุจุงุดุฑุฉ
if (require.main === module) {
    initializeSQLite()
        .then((success) => {
            if (success) {
                console.log('โ SQLite ุฌุงูุฒ ููุงุณุชุฎุฏุงู!');
                console.log('๐ก ูุงุณุชุฎุฏุงู MySQL ุจุฏูุงู ูู SQLiteุ ุงุชุจุน ุฏููู MYSQL_SETUP_GUIDE.md');
            }
            db.close();
            process.exit(success ? 0 : 1);
        });
}

module.exports = { db, initializeSQLite, dbPath };
