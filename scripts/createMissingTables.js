/**
 * ุฅูุดุงุก ุงูุฌุฏุงูู ุงูููููุฏุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
 */

const sqlite3 = require('sqlite3').verbose();
const path = require('path');

const dbPath = path.join(__dirname, '..', 'data', 'tamsik.db');

console.log('๐ ุฅูุดุงุก ุงูุฌุฏุงูู ุงูููููุฏุฉ...');

const db = new sqlite3.Database(dbPath, (err) => {
    if (err) {
        console.error('โ ุฎุทุฃ ูู ุงูุงุชุตุงู ุจูุงุนุฏุฉ ุงูุจูุงูุงุช:', err.message);
        process.exit(1);
    } else {
        console.log('โ ุชู ุงูุงุชุตุงู ุจูุงุนุฏุฉ ุงูุจูุงูุงุช ุจูุฌุงุญ');
    }
});

// ุชุนุฑูู ุงูุฌุฏุงูู ุงูููููุฏุฉ
const missingTables = {
    scholars: `
        CREATE TABLE IF NOT EXISTS scholars (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            user_id INTEGER,
            name TEXT NOT NULL,
            title TEXT,
            bio TEXT,
            specialization TEXT,
            location TEXT,
            image TEXT,
            education TEXT,
            experience TEXT,
            contact_info TEXT,
            social_links TEXT,
            is_featured INTEGER DEFAULT 0,
            is_active INTEGER DEFAULT 1,
            fatwa_count INTEGER DEFAULT 0,
            rating REAL DEFAULT 0.0,
            created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
            updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
            FOREIGN KEY (user_id) REFERENCES users(id)
        )
    `,
    
    fatwas: `
        CREATE TABLE IF NOT EXISTS fatwas (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            scholar_id INTEGER,
            category_id INTEGER,
            title TEXT NOT NULL,
            question TEXT NOT NULL,
            answer TEXT,
            questioner_name TEXT,
            questioner_email TEXT,
            status TEXT DEFAULT 'pending',
            is_featured INTEGER DEFAULT 0,
            views_count INTEGER DEFAULT 0,
            likes_count INTEGER DEFAULT 0,
            tags TEXT,
            created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
            updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
            FOREIGN KEY (scholar_id) REFERENCES scholars(id),
            FOREIGN KEY (category_id) REFERENCES categories(id)
        )
    `,
    
    thinkers: `
        CREATE TABLE IF NOT EXISTS thinkers (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            user_id INTEGER,
            name TEXT NOT NULL,
            title TEXT,
            bio TEXT,
            specialization TEXT,
            location TEXT,
            image TEXT,
            birth_date DATE,
            death_date DATE,
            education TEXT,
            works TEXT,
            achievements TEXT,
            quotes TEXT,
            books TEXT,
            social_links TEXT,
            is_featured INTEGER DEFAULT 0,
            is_active INTEGER DEFAULT 1,
            created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
            updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
            FOREIGN KEY (user_id) REFERENCES users(id)
        )
    `,
    
    newsletters: `
        CREATE TABLE IF NOT EXISTS newsletters (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            email TEXT UNIQUE NOT NULL,
            name TEXT,
            status TEXT DEFAULT 'active',
            preferences TEXT,
            subscribed_at DATETIME DEFAULT CURRENT_TIMESTAMP,
            unsubscribed_at DATETIME,
            verification_token TEXT,
            is_verified INTEGER DEFAULT 0
        )
    `
};

// ุฏุงูุฉ ูุฅูุดุงุก ุงูุฌุฏุงูู
async function createMissingTables() {
    return new Promise((resolve, reject) => {
        const tableNames = Object.keys(missingTables);
        let completed = 0;
        let errors = [];
        
        console.log('๐ ุฅูุดุงุก ุงูุฌุฏุงูู ุงูููููุฏุฉ...');
        
        tableNames.forEach(tableName => {
            db.run(missingTables[tableName], (err) => {
                if (err) {
                    console.error(`โ ุฎุทุฃ ูู ุฅูุดุงุก ุฌุฏูู ${tableName}:`, err.message);
                    errors.push({ table: tableName, error: err.message });
                } else {
                    console.log(`โ ุชู ุฅูุดุงุก ุฌุฏูู ${tableName}`);
                }
                
                completed++;
                if (completed === tableNames.length) {
                    if (errors.length > 0) {
                        reject(errors);
                    } else {
                        resolve();
                    }
                }
            });
        });
    });
}

// ุฏุงูุฉ ูุฅุฏุฑุงุฌ ุจูุงูุงุช ุฃูููุฉ ููุนููุงุก
async function insertInitialScholars() {
    return new Promise((resolve, reject) => {
        console.log('๐ ุฅุฏุฑุงุฌ ุจูุงูุงุช ุฃูููุฉ ููุนููุงุก...');
        
        const scholars = [
            {
                name: 'ุงูุดูุฎ ุนุจุฏ ุงูุนุฒูุฒ ุจู ุจุงุฒ',
                title: 'ุงูููุชู ุงูุนุงู ุงูุณุงุจู ููููููุฉ ุงูุนุฑุจูุฉ ุงูุณุนูุฏูุฉ',
                bio: 'ุนุงูู ุฌููู ูููุชู ุงูููููุฉ ุงูุนุฑุจูุฉ ุงูุณุนูุฏูุฉ ุงูุณุงุจูุ ุฑุญูู ุงููู',
                specialization: 'ุงูููู ูุงูุนููุฏุฉ',
                location: 'ุงูููููุฉ ุงูุนุฑุจูุฉ ุงูุณุนูุฏูุฉ',
                is_featured: 1,
                is_active: 1
            },
            {
                name: 'ุงูุดูุฎ ูุญูุฏ ุจู ุตุงูุญ ุงูุนุซูููู',
                title: 'ุนุงูู ููููู',
                bio: 'ูู ูุจุงุฑ ุนููุงุก ุงูููููุฉ ุงูุนุฑุจูุฉ ุงูุณุนูุฏูุฉุ ุฑุญูู ุงููู',
                specialization: 'ุงูููู ูุงูุชูุณูุฑ',
                location: 'ุงูููููุฉ ุงูุนุฑุจูุฉ ุงูุณุนูุฏูุฉ',
                is_featured: 1,
                is_active: 1
            },
            {
                name: 'ุงูุดูุฎ ุนุจุฏ ุงููู ุจู ุฌุจุฑูู',
                title: 'ุนุงูู ูุฏุงุนูุฉ',
                bio: 'ุนุงูู ุฌููู ููู ุฃุจุฑุฒ ุนููุงุก ุนุตุฑูุ ุฑุญูู ุงููู',
                specialization: 'ุงูููู ูุงูุฏุนูุฉ',
                location: 'ุงูููููุฉ ุงูุนุฑุจูุฉ ุงูุณุนูุฏูุฉ',
                is_featured: 1,
                is_active: 1
            }
        ];
        
        const insertScholar = db.prepare(`
            INSERT OR IGNORE INTO scholars 
            (name, title, bio, specialization, location, is_featured, is_active) 
            VALUES (?, ?, ?, ?, ?, ?, ?)
        `);
        
        scholars.forEach(scholar => {
            insertScholar.run(
                scholar.name,
                scholar.title,
                scholar.bio,
                scholar.specialization,
                scholar.location,
                scholar.is_featured,
                scholar.is_active
            );
        });
        
        insertScholar.finalize((err) => {
            if (err) {
                console.error('โ ุฎุทุฃ ูู ุฅุฏุฑุงุฌ ุงูุนููุงุก:', err);
                reject(err);
            } else {
                console.log('โ ุชู ุฅุฏุฑุงุฌ ุงูุนููุงุก ุจูุฌุงุญ');
                resolve();
            }
        });
    });
}

// ุฏุงูุฉ ูุฅุฏุฑุงุฌ ุจูุงูุงุช ุฃูููุฉ ูููููุฑูู
async function insertInitialThinkers() {
    return new Promise((resolve, reject) => {
        console.log('๐ ุฅุฏุฑุงุฌ ุจูุงูุงุช ุฃูููุฉ ูููููุฑูู...');
        
        const thinkers = [
            {
                name: 'ุงูุฅูุงู ุงูุบุฒุงูู',
                title: 'ุญุฌุฉ ุงูุฅุณูุงู',
                bio: 'ุฃุจู ุญุงูุฏ ูุญูุฏ ุจู ูุญูุฏ ุงูุบุฒุงููุ ูููุณูู ูุนุงูู ูุณูู',
                specialization: 'ุงูููุณูุฉ ูุงูุชุตูู',
                location: 'ุฎุฑุงุณุงู',
                birth_date: '1058-01-01',
                death_date: '1111-12-19',
                is_featured: 1,
                is_active: 1
            },
            {
                name: 'ุงุจู ุฎูุฏูู',
                title: 'ูุคุณุณ ุนูู ุงูุงุฌุชูุงุน',
                bio: 'ุนุจุฏ ุงูุฑุญูู ุจู ูุญูุฏ ุจู ุฎูุฏููุ ูุคุฑุฎ ููููุฑ ุงุฌุชูุงุนู',
                specialization: 'ุงูุชุงุฑูุฎ ูุนูู ุงูุงุฌุชูุงุน',
                location: 'ุงูุฃูุฏูุณ',
                birth_date: '1332-05-27',
                death_date: '1406-03-17',
                is_featured: 1,
                is_active: 1
            },
            {
                name: 'ุงูุฅูุงู ุงูุดุงูุนู',
                title: 'ุฅูุงู ุงููุฐูุจ ุงูุดุงูุนู',
                bio: 'ูุญูุฏ ุจู ุฅุฏุฑูุณ ุงูุดุงูุนูุ ูููู ูุฅูุงู ูู ุฃุฆูุฉ ุงููุณูููู',
                specialization: 'ุงูููู ูุฃุตูู ุงูููู',
                location: 'ููุฉ ุงูููุฑูุฉ',
                birth_date: '767-01-01',
                death_date: '820-01-20',
                is_featured: 1,
                is_active: 1
            }
        ];
        
        const insertThinker = db.prepare(`
            INSERT OR IGNORE INTO thinkers 
            (name, title, bio, specialization, location, birth_date, death_date, is_featured, is_active) 
            VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)
        `);
        
        thinkers.forEach(thinker => {
            insertThinker.run(
                thinker.name,
                thinker.title,
                thinker.bio,
                thinker.specialization,
                thinker.location,
                thinker.birth_date,
                thinker.death_date,
                thinker.is_featured,
                thinker.is_active
            );
        });
        
        insertThinker.finalize((err) => {
            if (err) {
                console.error('โ ุฎุทุฃ ูู ุฅุฏุฑุงุฌ ุงููููุฑูู:', err);
                reject(err);
            } else {
                console.log('โ ุชู ุฅุฏุฑุงุฌ ุงููููุฑูู ุจูุฌุงุญ');
                resolve();
            }
        });
    });
}

// ุฏุงูุฉ ุงูุชููุฆุฉ ุงูุฑุฆูุณูุฉ
async function initializeMissingTables() {
    try {
        await createMissingTables();
        await insertInitialScholars();
        await insertInitialThinkers();
        console.log('๐ ุชู ุฅูุดุงุก ุงูุฌุฏุงูู ุงูููููุฏุฉ ูุฅุฏุฑุงุฌ ุงูุจูุงูุงุช ุงูุฃูููุฉ ุจูุฌุงุญ!');
        return true;
    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุฅูุดุงุก ุงูุฌุฏุงูู:', error);
        return false;
    }
}

// ุชุดุบูู ุงูุชููุฆุฉ ุฅุฐุง ุชู ุงุณุชุฏุนุงุก ุงูููู ูุจุงุดุฑุฉ
if (require.main === module) {
    initializeMissingTables()
        .then((success) => {
            db.close();
            process.exit(success ? 0 : 1);
        });
}

module.exports = { initializeMissingTables };
